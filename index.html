<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Huelgas Estudiantiles</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Importa la fuente Inter de Google Fonts para una mejor tipografía */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un fondo gris claro para la aplicación */
        }
        /* Clase para centrar el contenido principal en la pantalla */
        .container-center {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ocupa al menos la altura completa de la ventana */
            padding: 1rem; /* Pequeño padding para dispositivos móviles */
        }
        /* Estilos generales para las "cards" o secciones de la aplicación */
        .card {
            background-color: white;
            padding: 2.5rem; /* Padding interno */
            border-radius: 0.75rem; /* Bordes redondeados */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Sombra sutil */
            width: 100%;
            max-width: 28rem; /* Ancho máximo para la tarjeta de login */
        }
        /* Estilos para los campos de entrada de formulario */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Borde gris claro */
            border-radius: 0.375rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            box-sizing: border-box; /* Asegura que padding y border no aumenten el ancho */
        }
        /* Estilo para el botón primario (azul índigo) */
        .btn-primary {
            width: 100%;
            background-color: #4f46e5; /* Color índigo */
            color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out; /* Transición suave al hover */
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Tono más oscuro al hover */
        }
        /* Estilo para botones secundarios (gris) */
        .btn-secondary {
            background-color: #6b7280; /* Color gris */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        /* Estilo para botones de peligro (rojo) */
        .btn-danger {
            background-color: #ef4444; /* Color rojo */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        /* Clase para ocultar elementos */
        .hidden {
            display: none !important;
        }
        /* Estilos para la caja de mensajes (toast) */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0; /* Inicialmente invisible */
            transition: opacity 0.3s ease-in-out; /* Transición suave para aparecer/desaparecer */
        }
        .message-box.show {
            opacity: 1; /* Visible */
        }
        /* Estilos para el modal de confirmación */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
        }
        /* Estilos responsivos para tablas */
        @media (max-width: 768px) {
            .card {
                padding: 1.5rem;
            }
            .max-w-4xl { /* Ajuste para la sección de docente en móviles */
                max-width: 95%;
            }
            .grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr; /* Una columna en pantallas pequeñas */
            }
        }
        /* Estilo para el indicador de evento finalizado */
        .event-finished-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #ef4444; /* Rojo */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px; /* Totalmente redondeado */
            font-size: 0.75rem; /* Texto pequeño */
            font-weight: 600;
            line-height: 1; /* Asegura que el texto no se salga */
        }
        /* Asegura que la tarjeta de huelga sea el contenedor para la posición absoluta */
        .strike-card-relative {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Caja de mensajes para notificaciones al usuario -->
    <div id="message-box" class="message-box"></div>

    <!-- Modal de confirmación -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800" id="modal-title">Confirmar Acción</h3>
            <p class="text-gray-700 mb-6" id="modal-message">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="btn-secondary rounded-md px-4 py-2">Cancelar</button>
                <button id="modal-confirm-btn" class="btn-danger rounded-md px-4 py-2">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Carga Masiva de Estudiantes -->
    <div id="bulk-upload-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Carga Masiva de Estudiantes</h3>
            <p class="text-gray-700 mb-4 text-left">Selecciona un archivo CSV. El formato esperado es de 3 columnas (sin encabezado), conteniendo:</p>
            <ul class="list-disc list-inside text-gray-600 text-left mb-6">
                <li>`nombre_usuario`</li>
                <li>`nombre_completo`</li>
                <li>`clave`</li>
            </ul>
            <p class="text-gray-700 mb-4 text-left">Las columnas pueden estar separadas por **comas (`,`)** o **puntos y coma (`;`)`)**.</p>
            <input type="file" id="csv-file-input" accept=".csv" class="mb-4 form-input border-none">
            <div id="bulk-upload-results" class="text-sm text-left my-4 max-h-40 overflow-y-auto"></div>
            <div class="modal-buttons">
                <button id="close-bulk-upload-modal-btn" class="btn-secondary rounded-md px-4 py-2">Cerrar</button>
                <button id="perform-bulk-upload-btn" class="btn-primary rounded-md px-4 py-2">Subir CSV</button>
            </div>
        </div>
    </div>

    <div id="app" class="container-center">
        <!-- Sección de Login: Visible al inicio y al cerrar sesión -->
        <div id="login-section" class="card">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Gestión de Huelgas</h2>
            <div class="mb-4">
                <label for="role-select" class="block text-gray-700 text-sm font-semibold mb-2">Seleccione su Rol:</label>
                <select id="role-select" class="form-input rounded-md">
                    <option value="teacher">Docente</option>
                    <option value="student">Estudiante</option>
                </select>
            </div>

            <!-- Formulario de Login para Docente -->
            <form id="teacher-login-form" class="">
                <div class="mb-4">
                    <label for="teacher-password" class="block text-gray-700 text-sm font-semibold mb-2">Clave Docente:</label>
                    <input type="password" id="teacher-password" class="form-input rounded-md" placeholder="Ingrese su clave">
                </div>
                <button type="submit" class="btn-primary rounded-md">Entrar como Docente</button>
            </form>

            <!-- Formulario de Login para Estudiante (incluye delegados ahora) -->
            <form id="student-login-form" class="hidden">
                <div class="mb-4">
                    <label for="student-username" class="block text-gray-700 text-sm font-semibold mb-2">Usuario:</label>
                    <input type="text" id="student-username" class="form-input rounded-md" placeholder="Ingrese su usuario">
                </div>
                <div class="mb-4">
                    <label for="student-password" class="block text-gray-700 text-sm font-semibold mb-2">Clave:</label>
                    <input type="password" id="student-password" class="form-input rounded-md" placeholder="Ingrese su clave">
                </div>
                <button type="submit" class="btn-primary rounded-md">Entrar</button>
            </form>
        </div>

        <!-- Sección de Docente: Visible solo para usuarios logueados como Docente -->
        <div id="teacher-section" class="card hidden max-w-4xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Sección Docente</h2>
            <button id="logout-teacher-btn" class="btn-secondary rounded-md float-right -mt-10 mr-2">Cerrar Sesión</button>

            <!-- Sección para Cambiar la Clave del Delegado -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Cambiar Clave del Delegado</h3>
                <form id="change-delegate-password-form">
                    <div class="mb-4">
                        <label for="new-delegate-password" class="block text-gray-700 text-sm font-semibold mb-2">Nueva Clave del Delegado:</label>
                        <input type="password" id="new-delegate-password" class="form-input rounded-md" placeholder="Ingrese la nueva clave del delegado">
                    </div>
                    <button type="submit" class="btn-primary rounded-md">Actualizar Clave Delegado</button>
                </form>
            </div>

            <!-- Sección para Gestionar Estudiantes (Añadir/Eliminar/Designar Delegado) -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Gestionar Estudiantes</h3>
                <form id="add-student-form" class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="student-add-username" class="block text-gray-700 text-sm font-semibold mb-2">Usuario:</label>
                            <input type="text" id="student-add-username" class="form-input rounded-md" placeholder="Ej: jsmith" required>
                        </div>
                        <div>
                            <label for="student-add-fullname" class="block text-gray-700 text-sm font-semibold mb-2">Nombre Completo:</label>
                            <input type="text" id="student-add-fullname" class="form-input rounded-md" placeholder="Ej: John Smith" required>
                        </div>
                        <div>
                            <label for="student-add-password" class="block text-gray-700 text-sm font-semibold mb-2">Clave:</label>
                            <input type="password" id="student-add-password" class="form-input rounded-md" placeholder="Clave para el estudiante" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary rounded-md mt-4">Añadir Estudiante</button>
                </form>
                <button id="bulk-upload-students-btn" class="btn-secondary rounded-md mt-2 w-full">Cargar Estudiantes desde CSV</button>
                <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2 mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre Completo</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                            <!-- Las filas de estudiantes se inyectarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sección para Ver la Lista de Huelgas Creadas -->
            <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Lista de Huelgas</h3>
                <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-2">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título (Descripción)</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Prevista</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adheridos</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="strike-list-teacher" class="bg-white divide-y divide-gray-200">
                            <!-- Las filas de huelgas se inyectarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección de Delegado: Visible solo para usuarios logueados como Delegado -->
        <div id="delegate-section" class="card hidden max-w-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Sección Delegado</h2>
            <button id="logout-delegate-btn" class="btn-secondary rounded-md float-right -mt-10 mr-2">Cerrar Sesión</button>

            <!-- Formulario para Crear Eventos de Huelga -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Crear Evento de Huelga</h3>
                <form id="create-strike-form">
                    <div class="mb-4">
                        <label for="strike-date" class="block text-gray-700 text-sm font-semibold mb-2">Fecha de la Huelga:</label>
                        <input type="date" id="strike-date" class="form-input rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="strike-course" class="block text-gray-700 text-sm font-semibold mb-2">Curso al que afectará:</label>
                        <input type="text" id="strike-course" class="form-input rounded-md" placeholder="Ej: 2º Bachillerato A" required>
                    </div>
                    <div class="mb-4">
                        <label for="strike-description" class="block text-gray-700 text-sm font-semibold mb-2">Descripción Breve:</label>
                        <textarea id="strike-description" class="form-input rounded-md" rows="3" placeholder="Breve descripción de la huelga..." required></textarea>
                    </div>
                    <button type="submit" class="btn-primary rounded-md">Crear Huelga</button>
                </form>
            </div>

            <!-- Sección de Huelgas Disponibles para Delegado (puede adherirse) -->
            <div class="p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto strike-card-relative">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Tus Huelgas Creadas y Adhesiones</h3>
                <p id="no-strikes-message-delegate" class="text-gray-500 text-center py-4 hidden">No hay huelgas disponibles en este momento.</p>
                <div id="delegate-strikes-list">
                    <!-- Las huelgas se inyectarán aquí dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Sección de Estudiante: Visible solo para usuarios logueados como Estudiante NO delegado -->
        <div id="student-section" class="card hidden max-w-2xl">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Sección Estudiante</h2>
            <button id="logout-student-btn" class="btn-secondary rounded-md float-right -mt-10 mr-2">Cerrar Sesión</button>

            <p class="text-gray-600 mb-4">Bienvenido, <span id="student-fullname-display" class="font-semibold"></span>!</p>

            <div class="p-4 bg-gray-50 rounded-lg max-h-96 overflow-y-auto strike-card-relative">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Huelgas Disponibles</h3>
                <p id="no-strikes-message-student" class="text-gray-500 text-center py-4 hidden">No hay huelgas disponibles en este momento.</p>
                <div id="student-strikes-list">
                    <!-- Las huelgas se inyectarán aquí dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- SDKs de Firebase -->
    <script type="module">
        // Importa las funciones necesarias de Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales
        const firebaseConfig = {
                  apiKey: "AIzaSyAnCGJ3aQPI0SUY461cJ8bQbO_UWx0Q7v4",
                  authDomain: "gestiondehuelgas.firebaseapp.com",
                  projectId: "gestiondehuelgas",
                  storageBucket: "gestiondehuelgas.firebasestorage.app",
                  messagingSenderId: "527352835343",
                  appId: "1:527352835343:web:4d863831e2af01c3bd627a"
                };
        const appId = firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /*
        // EJEMPLO: Si publicas en GitHub Pages, DEBES descomentar y reemplazar con tus credenciales REALES:
        const myFirebaseConfig = {
             apiKey: "TU_API_KEY_REAL",
             authDomain: "TU_AUTH_DOMAIN_REAL",
             projectId: "TU_PROJECT_ID_REAL",
             storageBucket: "TU_STORAGE_BUCKET_REAL",
             messagingSenderId: "TU_MESSAGING_SENDER_ID_REAL",
             appId: "TU_WEB_APP_ID_REAL"
        };
        const appId = myFirebaseConfig.projectId; // O usa un ID de tu elección para segmentar tus datos
        const firebaseConfig = myFirebaseConfig;
        */

        // Inicialización de Firebase
        let app, db, auth;
        let currentUserId = null; // UID del usuario autenticado en Firebase
        let isAuthReady = false; // Bandera para indicar si Firebase Auth está listo
        let allStrikes = []; // Global variable to hold all strikes data


        // Referencias a elementos del DOM
        const messageBox = document.getElementById('message-box');
        const loginSection = document.getElementById('login-section');
        const teacherSection = document.getElementById('teacher-section');
        const delegateSection = document.getElementById('delegate-section');
        const studentSection = document.getElementById('student-section');

        const roleSelect = document.getElementById('role-select');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const studentLoginForm = document.getElementById('student-login-form'); // Este ahora incluye delegados

        // Elementos del modal de confirmación
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let resolveModalPromise; // Para manejar la promesa del modal

        // Elementos del modal de carga masiva
        const bulkUploadModal = document.getElementById('bulk-upload-modal');
        const csvFileInput = document.getElementById('csv-file-input');
        const performBulkUploadBtn = document.getElementById('perform-bulk-upload-btn');
        const closeBulkUploadModalBtn = document.getElementById('close-bulk-upload-modal-btn');
        const bulkUploadResults = document.getElementById('bulk-upload-results');


        // Elementos de la sección del Docente
        const teacherPasswordInput = document.getElementById('teacher-password');
        const logoutTeacherBtn = document.getElementById('logout-teacher-btn');
        const changeDelegatePasswordForm = document.getElementById('change-delegate-password-form'); // Nuevo/reintroducido
        const newDelegatePasswordInput = document.getElementById('new-delegate-password'); // Nuevo/reintroducido
        const addStudentForm = document.getElementById('add-student-form');
        const studentAddUsernameInput = document.getElementById('student-add-username');
        const studentAddFullnameInput = document.getElementById('student-add-fullname');
        const studentAddPasswordInput = document.getElementById('student-add-password');
        const bulkUploadStudentsBtn = document.getElementById('bulk-upload-students-btn');
        const studentListTable = document.getElementById('student-list');
        const strikeListTeacherTable = document.getElementById('strike-list-teacher');

        // Elementos de la sección del Delegado (ahora solo para interfaz)
        const logoutDelegateBtn = document.getElementById('logout-delegate-btn');
        const createStrikeForm = document.getElementById('create-strike-form');
        const strikeDateInput = document.getElementById('strike-date');
        const strikeCourseInput = document.getElementById('strike-course'); // Corrección del typo aquí
        const strikeDescriptionInput = document.getElementById('strike-description');
        const delegateStrikesList = document.getElementById('delegate-strikes-list'); // Nuevo
        const noStrikesMessageDelegate = document.getElementById('no-strikes-message-delegate'); // Nuevo

        // Elementos de la sección del Estudiante
        const studentUsernameInput = document.getElementById('student-username');
        const studentPasswordInput = document.getElementById('student-password');
        const logoutStudentBtn = document.getElementById('logout-student-btn');
        const studentFullnameDisplay = document.getElementById('student-fullname-display');
        const studentStrikesList = document.getElementById('student-strikes-list'); // Renombrado de strikes-for-students-list
        const noStrikesMessageStudent = document.getElementById('no-strikes-message-student'); // Renombrado de no-strikes-message


        // Estado de la sesión actual (se guarda en localStorage para persistencia básica)
        let currentRole = localStorage.getItem('currentRole') || null;
        let currentStudentId = localStorage.getItem('currentStudentId') || null; // ID de Firestore del estudiante
        let currentStudentUsername = localStorage.getItem('currentStudentUsername') || null;
        let currentStudentFullName = localStorage.getItem('currentStudentFullName') || null;
        let isCurrentStudentDelegate = localStorage.getItem('isCurrentStudentDelegate') === 'true'; // Nuevo: si el estudiante logueado es delegado


        // --- Funciones de Utilidad ---

        /**
         * Muestra un mensaje temporal en una caja de notificación (toast).
         * @param {string} message El mensaje a mostrar.
         * @param {number} duration La duración en milisegundos que el mensaje estará visible.
         */
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        /**
         * Muestra un modal de confirmación personalizado.
         * @param {string} title El título del modal.
         * @param {string} message El mensaje de confirmación.
         * @returns {Promise<boolean>} Una promesa que se resuelve a true si el usuario confirma, false si cancela.
         */
        function showConfirmationModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmationModal.classList.remove('hidden');

            return new Promise(resolve => {
                resolveModalPromise = resolve; // Guarda la función resolve para llamarla desde los botones del modal
            });
        }

        // Event listeners para los botones del modal de confirmación
        modalConfirmBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if (resolveModalPromise) {
                resolveModalPromise(true); // Resuelve la promesa con true (confirmado)
                resolveModalPromise = null;
            }
        });

        modalCancelBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if (resolveModalPromise) {
                resolveModalPromise(false); // Resuelve la promesa con false (cancelado)
                resolveModalPromise = null;
            }
        });


        /**
         * Muestra la sección HTML especificada y oculta todas las demás.
         * @param {HTMLElement} sectionToShow El elemento HTML de la sección a mostrar.
         */
        function showSection(sectionToShow) {
            // Oculta todas las secciones
            loginSection.classList.add('hidden');
            teacherSection.classList.add('hidden');
            delegateSection.classList.add('hidden');
            studentSection.classList.add('hidden');
            // Muestra solo la sección deseada
            sectionToShow.classList.remove('hidden');
        }

        /**
         * Función de hashing simple para contraseñas.
         * NOTA: Para producción, se recomienda usar una librería de hashing criptográfico fuerte como bcrypt.
         * @param {string} password La contraseña a hashear.
         * @returns {string} La contraseña hasheada.
         */
        function simpleHash(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convierte a entero de 32 bits
            }
            return hash.toString();
        }

        /**
         * Obtiene la dirección IP pública del usuario mediante una API externa.
         * @returns {Promise<string|null>} La dirección IP pública o null si ocurre un error.
         */
        async function getPublicIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Error al obtener la IP pública:", error);
                showMessage("No se pudo obtener la IP pública. Asegúrate de tener conexión.", 5000);
                return null;
            }
        }

        /**
         * Limpia los datos de la sesión almacenados en localStorage y redirige a la pantalla de login.
         */
        function clearLocalStorageAndLogout() {
            localStorage.removeItem('currentRole');
            localStorage.removeItem('currentStudentId');
            localStorage.removeItem('currentStudentUsername');
            localStorage.removeItem('currentStudentFullName');
            localStorage.removeItem('isCurrentStudentDelegate'); // Nuevo: limpia el flag de delegado
            currentRole = null;
            currentStudentId = null;
            currentStudentUsername = null;
            currentStudentFullName = null;
            isCurrentStudentDelegate = false;

            showSection(loginSection); // Muestra la sección de login
            // Reinicia los campos de entrada y el selector de rol
            teacherPasswordInput.value = '';
            studentUsernameInput.value = '';
            studentPasswordInput.value = '';
            roleSelect.value = 'teacher'; // Restablece el desplegable a 'Docente'
            teacherLoginForm.classList.remove('hidden'); // Muestra el formulario de docente por defecto
            studentLoginForm.classList.add('hidden');

            // Intenta cerrar sesión de Firebase Auth (esto limpiará el token de autenticación)
            signOut(auth).then(() => {
                console.log("Sesión de Firebase cerrada.");
            }).catch((error) => {
                console.error("Error al cerrar sesión de Firebase:", error);
                showMessage("Error al cerrar sesión de Firebase.", 3000);
            });
        }

        // --- Inicialización y Autenticación de Firebase ---

        /**
         * Inicializa Firebase y configura el listener de autenticación.
         * Esta función es el punto de entrada para toda la lógica de la aplicación.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // Imprime la configuración de Firebase para depuración
                console.log("Firebase config usada:", firebaseConfig);

                // Inicializa la aplicación Firebase con la configuración proporcionada
                app = initializeApp(firebaseConfig);
                db = getFirestore(app); // Obtiene la instancia de Firestore
                auth = getAuth(app);     // Obtiene la instancia de Auth

                // Escucha cambios en el estado de autenticación de Firebase
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Firebase Auth UID:", currentUserId);
                        isAuthReady = true; // Auth está listo
                        // Ahora que el usuario está autenticado, configuramos los listeners de la aplicación
                        setupAppListeners();
                        
                        // Restaura la sesión basada en el rol almacenado
                        if (currentRole) {
                            if (currentRole === 'teacher') {
                                showSection(teacherSection);
                            } else if (currentRole === 'student') { // Ahora 'student' incluye delegados
                                studentFullnameDisplay.textContent = currentStudentFullName || currentStudentUsername || 'Estudiante';
                                if (isCurrentStudentDelegate) {
                                    showSection(delegateSection);
                                } else {
                                    showSection(studentSection);
                                }
                            }
                            showMessage(`Bienvenido, ${currentRole.charAt(0).toUpperCase() + currentRole.slice(1)}.`, 3000);
                        } else {
                            // Si no hay rol guardado (primera carga o logout), muestra la sección de login
                            showSection(loginSection);
                            teacherLoginForm.classList.remove('hidden');
                            studentLoginForm.classList.add('hidden');
                        }
                    } else {
                        isAuthReady = false; // Auth no está listo o no hay usuario
                        // El usuario no está autenticado, intenta iniciar sesión (anónimamente o con token personalizado)
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Iniciado sesión con token personalizado.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Iniciado sesión de forma anónima.");
                            }
                        } catch (error) {
                            console.error("Error al iniciar sesión anónima:", error);
                            // Este error es el que estamos depurando, por eso el mensaje es más específico
                            showMessage("Error al iniciar sesión. Asegúrate de que Firebase Auth esté habilitado y la API Key sea válida.", 8000);
                            // Si incluso el inicio de sesión anónima falla, permanece en la pantalla de login y muestra el error
                            showSection(loginSection);
                            teacherLoginForm.classList.remove('hidden');
                            studentLoginForm.classList.add('hidden');
                        }
                    }
                });
            } catch (error) {
                console.error("Fallo la inicialización de Firebase:", error);
                showMessage("Error al inicializar la aplicación. Verifique la configuración de Firebase.", 5000);
            }
        }

        /**
         * Configura los listeners en tiempo real para las colecciones de Firestore.
         * Se llama después de que Firebase se inicializa y el estado de autenticación está listo.
         */
        function setupAppListeners() {
            if (!db) return; // Asegúrate de que db esté inicializado

            // Listener para la colección de configuración de la aplicación (claves de docente)
            onSnapshot(doc(db, `artifacts/${appId}/public/data/app_settings`, 'settings'), (docSnapshot) => {
                if (!docSnapshot.exists()) {
                    // Si el documento de configuración no existe, lo crea con valores por defecto
                    setDoc(doc(db, `artifacts/${appId}/public/data/app_settings`, 'settings'), {
                        teacherPassword: simpleHash('docente123'), // Clave docente por defecto
                    }).then(() => {
                        console.log("Configuración por defecto de la aplicación creada.");
                    }).catch(error => {
                        console.error("Error al crear la configuración por defecto:", error);
                        showMessage("Error al crear la configuración predeterminada.", 3000);
                    });
                }
            }, (error) => {
                console.error("Error al escuchar la configuración de la aplicación:", error);
                //showMessage("Error al cargar la configuración de la aplicación.", 3000);
            });

            // Listener para la colección de estudiantes (para la sección del docente)
            onSnapshot(collection(db, `artifacts/${appId}/public/data/students`), (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                displayStudents(students); // Actualiza la tabla de estudiantes en el DOM
            }, (error) => {
                console.error("Error al obtener estudiantes:", error);
                //showMessage("Error al cargar la lista de estudiantes.", 3000);
            });

            // Listener para la colección de huelgas (para docente y estudiante)
            onSnapshot(collection(db, `artifacts/${appId}/public/data/strikes`), async (snapshot) => {
                const strikes = [];
                // Para cada huelga, necesitamos obtener el conteo de adhesiones
                for (const doc of snapshot.docs) {
                    const strikeData = { id: doc.id, ...doc.data() };
                    const adhesionsQuery = query(collection(db, `artifacts/${appId}/public/data/strike_adhesions`), where('strikeId', '==', strikeData.id));
                    const adhesionsSnapshot = await getDocs(adhesionsQuery);
                    strikeData.adheredCount = adhesionsSnapshot.size; // Cantidad de estudiantes adheridos
                    // Almacena los datos completos de las adhesiones para la función de impresión del docente
                    strikeData.adhesions = adhesionsSnapshot.docs.map(adDoc => ({ id: adDoc.id, ...adDoc.data() }));
                    strikes.push(strikeData);
                }
                allStrikes = strikes; // Store the fetched strikes globally
                console.log("onSnapshot for strikes fired. Strikes:", allStrikes); // Debug para ver los datos que llegan
                displayStrikesForTeacher(allStrikes); // Actualiza la tabla de huelgas para el docente
                // Pasa el ID del contenedor correcto para la lista de huelgas del estudiante/delegado
                displayStrikesForStudents(allStrikes, 'student-strikes-list', 'no-strikes-message-student');
                displayStrikesForStudents(allStrikes, 'delegate-strikes-list', 'no-strikes-message-delegate');
            }, (error) => {
                console.error("Error al obtener huelgas:", error);
                //showMessage("Error al cargar la lista de huelgas.", 3000);
            });
        }

        // Llama a la función de inicialización cuando la ventana se carga completamente
        window.onload = initializeFirebaseAndAuth;


        // --- Event Listeners para Formularios de Login ---

        // Maneja el cambio en el selector de rol para mostrar el formulario de login adecuado
        roleSelect.addEventListener('change', (event) => {
            teacherLoginForm.classList.add('hidden');
            studentLoginForm.classList.add('hidden'); // Solo 2 opciones ahora
            switch (event.target.value) {
                case 'teacher':
                    teacherLoginForm.classList.remove('hidden');
                    break;
                case 'student':
                    studentLoginForm.classList.remove('hidden');
                    break;
            }
        });

        // Maneja el envío del formulario de login del Docente
        teacherLoginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!isAuthReady) {
                showMessage("La aplicación no está lista aún. Intente de nuevo en unos segundos.", 3000);
                return;
            }
            const password = teacherPasswordInput.value;
            if (!password) {
                showMessage("Por favor, ingrese la clave del docente.", 3000);
                return;
            }

            try {
                // Obtiene el documento de configuración para verificar la clave
                const docRef = doc(db, `artifacts/${appId}/public/data/app_settings`, 'settings');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && simpleHash(password) === docSnap.data().teacherPassword) {
                    localStorage.setItem('currentRole', 'teacher'); // Guarda el rol en localStorage
                    currentRole = 'teacher';
                    showSection(teacherSection); // Muestra la sección del docente
                    showMessage("Sesión de docente iniciada.", 3000);
                    teacherPasswordInput.value = ''; // Limpia el campo de contraseña
                } else {
                    showMessage("Clave de docente incorrecta.", 3000);
                }
            } catch (error) {
                console.error("Error durante el login del docente:", error);
                showMessage("Error al iniciar sesión como docente.", 3000);
            }
        });
        
        // Maneja el envío del formulario de login del Estudiante (ahora unificado)
        studentLoginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!isAuthReady) {
                showMessage("La aplicación no está lista aún. Intente de nuevo en unos segundos.", 3000);
                return;
            }
            const username = studentUsernameInput.value.trim();
            const password = studentPasswordInput.value;
            if (!username || !password) {
                showMessage("Por favor, ingrese usuario y clave.", 3000);
                return;
            }

            try {
                // Consulta la colección de estudiantes para encontrar el usuario
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where('username', '==', username.toLowerCase())); // Convertir a minúsculas
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const studentDoc = querySnapshot.docs[0];
                    const studentData = studentDoc.data();
                    // Verifica la contraseña hasheada
                    if (simpleHash(password) === studentData.passwordHash) {
                        localStorage.setItem('currentRole', 'student');
                        localStorage.setItem('currentStudentId', studentDoc.id); // Guarda el ID de Firestore del estudiante
                        localStorage.setItem('currentStudentUsername', studentData.username);
                        localStorage.setItem('currentStudentFullName', studentData.fullName);
                        localStorage.setItem('isCurrentStudentDelegate', studentData.isDelegate || false); // Guarda el flag de delegado
                        
                        currentRole = 'student';
                        currentStudentId = studentDoc.id;
                        currentStudentUsername = studentData.username;
                        currentStudentFullName = studentData.fullName;
                        isCurrentStudentDelegate = studentData.isDelegate || false; // Asigna el valor del flag

                        studentFullnameDisplay.textContent = studentData.fullName; // Muestra el nombre completo
                        
                        if (isCurrentStudentDelegate) {
                            showSection(delegateSection); // Si es delegado, va a la sección de delegado
                            showMessage(`Bienvenido, Delegado ${studentData.fullName}!`, 3000);
                        } else {
                            showSection(studentSection); // Si no es delegado, va a la sección de estudiante
                            showMessage(`Bienvenido, ${studentData.fullName}!`, 3000);
                        }
                        
                        studentUsernameInput.value = '';
                        studentPasswordInput.value = '';

                        // FORZAR RE-RENDER de las listas de huelgas con el ID de estudiante actualizado
                        displayStrikesForStudents(allStrikes, 'student-strikes-list', 'no-strikes-message-student');
                        displayStrikesForStudents(allStrikes, 'delegate-strikes-list', 'no-strikes-message-delegate');


                    } else {
                        showMessage("Clave incorrecta.", 3000);
                    }
                } else {
                    showMessage("Usuario no encontrado.", 3000);
                }
            } catch (error) {
                console.error("Error durante el login del estudiante:", error);
                showMessage("Error al iniciar sesión.", 3000);
            }
        });

        // --- Botones de Cerrar Sesión ---
        logoutTeacherBtn.addEventListener('click', clearLocalStorageAndLogout);
        logoutDelegateBtn.addEventListener('click', clearLocalStorageAndLogout); // Mantener por si acaso, aunque unificado
        logoutStudentBtn.addEventListener('click', clearLocalStorageAndLogout);

        // --- Funciones de la Sección del Docente ---

        // Maneja el envío del formulario para cambiar la clave del delegado
        changeDelegatePasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newPassword = newDelegatePasswordInput.value;
            if (!newPassword) {
                showMessage("Por favor, ingrese la nueva clave del delegado.", 3000);
                return;
            }

            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const currentDelegateQuery = query(studentsRef, where('isDelegate', '==', true));
                const currentDelegateSnapshot = await getDocs(currentDelegateQuery);

                if (!currentDelegateSnapshot.empty) {
                    const currentDelegateDoc = currentDelegateSnapshot.docs[0];
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, currentDelegateDoc.id), {
                        passwordHash: simpleHash(newPassword)
                    });
                    showMessage(`Clave del delegado '${currentDelegateDoc.data().username}' cambiada exitosamente.`, 3000);
                    newDelegatePasswordInput.value = '';
                } else {
                    showMessage("No se encontró ningún delegado para cambiar la clave.", 3000);
                }
            } catch (error) {
                console.error("Error al cambiar la clave del delegado:", error);
                showMessage("Error al cambiar la clave del delegado.", 3000);
            }
        });

        // Maneja el envío del formulario para añadir un nuevo estudiante
        addStudentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = studentAddUsernameInput.value.trim().toLowerCase(); // Guardar en minúsculas
            const fullName = studentAddFullnameInput.value.trim();
            const password = studentAddPasswordInput.value;

            if (!username || !fullName || !password) {
                showMessage("Todos los campos de estudiante son obligatorios.", 3000);
                return;
            }

            try {
                // Verifica si el nombre de usuario ya existe para evitar duplicados
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where('username', '==', username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage("El nombre de usuario ya existe. Elija otro.", 3000);
                    return;
                }

                // Añade el nuevo estudiante a la colección (siempre no delegado al crear)
                await addDoc(studentsRef, {
                    username: username,
                    fullName: fullName,
                    passwordHash: simpleHash(password), // Guarda la contraseña hasheada
                    isDelegate: false, // Por defecto, no es delegado al crear
                    createdAt: new Date()
                });
                showMessage("Estudiante añadido exitosamente.", 3000);
                addStudentForm.reset(); // Limpia el formulario
            } catch (error) {
                console.error("Error al añadir estudiante:", error);
                showMessage("Error al añadir estudiante.", 3000);
            }
        });

        /**
         * Manejador para el botón de carga masiva de estudiantes.
         */
        bulkUploadStudentsBtn.addEventListener('click', () => {
            bulkUploadModal.classList.remove('hidden');
            bulkUploadResults.innerHTML = ''; // Limpia los resultados anteriores
            csvFileInput.value = ''; // Limpia el input de archivo
        });

        /**
         * Manejador para cerrar el modal de carga masiva.
         */
        closeBulkUploadModalBtn.addEventListener('click', () => {
            bulkUploadModal.classList.add('hidden');
        });

        /**
         * Manejador para realizar la carga masiva de estudiantes desde el CSV.
         */
        performBulkUploadBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                showMessage("Por favor, selecciona un archivo CSV.", 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== ''); // Ignora líneas vacías
                let successCount = 0;
                let failCount = 0;
                const resultsHtml = [];
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    // Permite comas (,) o puntos y coma (;) como delimitadores
                    const parts = line.split(/[,;]/); 
                    if (parts.length === 3) {
                        const [usernameRaw, fullName, password] = parts.map(p => p.trim());
                        const username = usernameRaw.toLowerCase(); // Guardar en minúsculas
                        if (username && fullName && password) {
                            try {
                                // Verifica si el nombre de usuario ya existe para evitar duplicados
                                const q = query(studentsRef, where('username', '==', username));
                                const querySnapshot = await getDocs(q);

                                if (querySnapshot.empty) {
                                    await addDoc(studentsRef, {
                                        username: username,
                                        fullName: fullName,
                                        passwordHash: simpleHash(password),
                                        isDelegate: false, // Por defecto, no es delegado al cargar masivamente
                                        createdAt: new Date()
                                    });
                                    resultsHtml.push(`<p class="text-green-600">✅ Estudiante '${fullName}' (${username}) añadido.</p>`);
                                    successCount++;
                                } else {
                                    resultsHtml.push(`<p class="text-yellow-600">⚠️ Usuario '${username}' ya existe, saltado.</p>`);
                                    failCount++;
                                }
                            } catch (error) {
                                console.error(`Error al añadir estudiante '${username}':`, error);
                                resultsHtml.push(`<p class="text-red-600">❌ Error al añadir '${fullName}' (${username}): ${error.message}</p>`);
                                failCount++;
                            }
                        } else {
                            resultsHtml.push(`<p class="text-red-600">❌ Línea ${i + 1} incompleta: '${line}'</p>`);
                            failCount++;
                        }
                    } else {
                        resultsHtml.push(`<p class="text-red-600">❌ Línea ${i + 1} con formato incorrecto (se esperaban 3 columnas): '${line}'</p>`);
                        failCount++;
                    }
                }
                bulkUploadResults.innerHTML = resultsHtml.join('');
                showMessage(`Carga masiva completada: ${successCount} añadidos, ${failCount} errores/saltados.`, 5000);
            };
            reader.readAsText(file);
        });


        /**
         * Renderiza la lista de estudiantes en la sección del docente.
         * @param {Array} students Un array de objetos estudiante.
         */
        function displayStudents(students) {
            studentListTable.innerHTML = ''; // Limpia la tabla actual
            if (students.length === 0) {
                studentListTable.innerHTML = '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">No hay estudiantes registrados.</td></tr>';
                return;
            }
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${student.username}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${student.fullName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        ${student.isDelegate ? '<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Delegado ✅</span>' : ''}
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${student.id}" class="btn-danger rounded-md text-xs px-2 py-1 delete-student-btn mr-2">Eliminar</button>
                        ${!student.isDelegate ? `<button data-id="${student.id}" data-username="${student.username}" class="btn-secondary rounded-md text-xs px-2 py-1 make-delegate-btn">Hacer Delegado</button>` : ''}
                    </td>
                `;
                studentListTable.appendChild(row);
            });

            // Añade event listeners a los botones de eliminar estudiante
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const studentId = event.target.dataset.id;
                    const confirmed = await showConfirmationModal("Eliminar Estudiante", "¿Estás seguro de que quieres eliminar a este estudiante? Esto eliminará también sus adhesiones a huelgas.");
                    if (confirmed) {
                        try {
                            // Elimina el documento del estudiante
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/students`, studentId));

                            // También elimina todas las adhesiones de este estudiante a huelgas
                            const adhesionsRef = collection(db, `artifacts/${appId}/public/data/strike_adhesions`);
                            const q = query(adhesionsRef, where('studentId', '==', studentId));
                            const querySnapshot = await getDocs(q);
                            const deletePromises = [];
                            querySnapshot.forEach(adDoc => {
                                deletePromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/strike_adhesions`, adDoc.id)));
                            });
                            await Promise.all(deletePromises);

                            showMessage("Estudiante y sus adhesiones eliminados.", 3000);
                        } catch (error) {
                            console.error("Error al eliminar estudiante:", error);
                            showMessage("Error al eliminar estudiante.", 3000);
                        }
                    }
                });
            });

            // Añade event listeners a los botones de hacer delegado
            document.querySelectorAll('.make-delegate-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const newDelegateId = event.target.dataset.id;
                    const newDelegateUsername = event.target.dataset.username;
                    const confirmed = await showConfirmationModal("Designar Delegado", `¿Estás seguro de que quieres designar a '${newDelegateUsername}' como el nuevo delegado? Esto removerá el rol de delegado de cualquier otro estudiante.`);
                    
                    if (confirmed) {
                        try {
                            const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                            // 1. Encontrar el delegado actual (si existe) y remover su rol
                            const currentDelegateQuery = query(studentsRef, where('isDelegate', '==', true));
                            const currentDelegateSnapshot = await getDocs(currentDelegateQuery);

                            if (!currentDelegateSnapshot.empty) {
                                const currentDelegateDoc = currentDelegateSnapshot.docs[0];
                                // Solo si el delegado actual no es el mismo que el nuevo
                                if (currentDelegateDoc.id !== newDelegateId) {
                                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, currentDelegateDoc.id), {
                                        isDelegate: false
                                    });
                                    showMessage(`Rol de delegado removido de '${currentDelegateDoc.data().username}'.`, 2000);
                                }
                            }

                            // 2. Asignar el rol de delegado al nuevo estudiante
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, newDelegateId), {
                                isDelegate: true
                            });
                            showMessage(`'${newDelegateUsername}' es ahora el delegado.`, 3000);

                        } catch (error) {
                            console.error("Error al designar delegado:", error);
                            showMessage("Error al designar delegado. Por favor, inténtalo de nuevo.", 5000);
                        }
                    }
                });
            });
        }

        /**
         * Renderiza la lista de huelgas en la sección del docente.
         * Incluye el conteo de adheridos y botones para eliminar e imprimir.
         * @param {Array} strikes Un array de objetos huelga con conteo de adhesiones.
         */
        function displayStrikesForTeacher(strikes) {
            strikeListTeacherTable.innerHTML = ''; // Limpia la tabla actual
            if (strikes.length === 0) {
                strikeListTeacherTable.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-center text-gray-500">No hay huelgas creadas.</td></tr>';
                return;
            }
            // Ordena las huelgas por fecha
            strikes.sort((a, b) => new Date(a.date) - new Date(b.date));
            strikes.forEach(strike => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${strike.description}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${strike.date}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${strike.course}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 font-semibold">${strike.adheredCount}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${strike.id}" class="btn-danger rounded-md text-xs px-2 py-1 delete-strike-btn mr-2">Eliminar</button>
                        <button data-id="${strike.id}" class="btn-secondary rounded-md text-xs px-2 py-1 print-strike-btn">Imprimir Lista</button>
                    </td>
                `;
                strikeListTeacherTable.appendChild(row);
            });

            // Añade event listeners a los botones de imprimir lista
            document.querySelectorAll('.print-strike-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const strikeId = event.target.dataset.id;
                    const strike = strikes.find(s => s.id === strikeId);
                    if (!strike) {
                        showMessage("Huelga no encontrada para imprimir.", 3000);
                        return;
                    }

                    const adheredStudentsDetails = [];
                    // Crea un Set para evitar buscar IDs de estudiante duplicados
                    const uniqueStudentIds = new Set(strike.adhesions.map(ad => ad.studentId));
                    const studentDetailsPromises = [];

                    // Recupera los detalles completos de cada estudiante adherido
                    for (const studentId of uniqueStudentIds) {
                        // Ahora bajo public/data
                        studentDetailsPromises.push(getDoc(doc(db, `artifacts/${appId}/public/data/students`, studentId)));
                    }

                    const studentDetailsSnapshots = await Promise.all(studentDetailsPromises);
                    const studentMap = new Map(); // Mapa de studentId a datos completos del estudiante
                    studentDetailsSnapshots.forEach(snap => {
                        if (snap.exists()) {
                            studentMap.set(snap.id, snap.data());
                        }
                    });

                    // Prepara los datos para la impresión, combinando info de adhesión con nombre completo del estudiante
                    strike.adhesions.forEach(adhesion => {
                        const student = studentMap.get(adhesion.studentId);
                        if (student) {
                            adheredStudentsDetails.push({
                                fullName: student.fullName,
                                username: student.username,
                                publicIp: adhesion.publicIp,
                                // Convierte el Timestamp de Firebase a un formato legible
                                adheredAt: adhesion.adheredAt ? new Date(adhesion.adheredAt.seconds * 1000).toLocaleString() : 'N/A'
                            });
                        }
                    });

                    // Ordena la lista de estudiantes adheridos por nombre completo
                    adheredStudentsDetails.sort((a, b) => a.fullName.localeCompare(b.fullName));

                    // Genera el contenido HTML para la impresión
                    let printContent = `
                        <div style="font-family: 'Inter', sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #1f2937; margin-bottom: 20px;">Lista de Adhesiones a la Huelga</h1>
                            <p style="font-size: 1.1rem; color: #374151;"><strong>Título:</strong> ${strike.description}</p>
                            <p style="font-size: 1.1rem; color: #374151;"><strong>Fecha Prevista:</strong> ${strike.date}</p>
                            <p style="font-size: 1.1rem; color: #374151; margin-bottom: 20px;"><strong>Curso Afectado:</strong> ${strike.course}</p>
                            <h2 style="font-size: 1.4rem; color: #1f2937; margin-top: 30px; margin-bottom: 15px;">Estudiantes Adheridos (${adheredStudentsDetails.length})</h2>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                <thead style="background-color: #f3f4f6;">
                                    <tr>
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-size: 0.9rem; color: #4b5563;">Nombre Completo</th>
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-size: 0.9rem; color: #4b5563;">Usuario</th>
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-size: 0.9rem; color: #4b5563;">IP Pública</th>
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; font-size: 0.9rem; color: #4b5563;">Fecha/Hora de Adhesión</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    if (adheredStudentsDetails.length === 0) {
                        printContent += `
                            <tr>
                                <td colspan="4" style="padding: 10px; border: 1px solid #e5e7eb; text-align: center; color: #6b7280;">Ningún estudiante se ha adherido aún a esta huelga.</td>
                            </tr>
                        `;
                    } else {
                        adheredStudentsDetails.forEach(student => {
                            printContent += `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 0.9rem; color: #374151;">${student.fullName}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 0.9rem; color: #374151;">${student.username}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 0.9rem; color: #374151;">${student.publicIp}</td>
                                    <td style="padding: 10px; border: 1px solid #e5e7eb; font-size: 0.9rem; color: #374151;">${student.adheredAt}</td>
                                </tr>
                            `;
                        });
                    }

                    printContent += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    // Abre una nueva ventana, escribe el contenido y la imprime
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                });
            });
        }


        // --- Funciones de la Sección del Delegado ---

        // Maneja el envío del formulario para crear una nueva huelga
        createStrikeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const date = strikeDateInput.value;
            const course = strikeCourseInput.value.trim();
            const description = strikeDescriptionInput.value.trim();

            if (!date || !course || !description) {
                showMessage("Todos los campos de la huelga son obligatorios.", 3000);
                return;
            }

            try {
                // Añade el documento de la nueva huelga a la colección pública
                await addDoc(collection(db, `artifacts/${appId}/public/data/strikes`), {
                    date: date,
                    course: course,
                    description: description,
                    createdAt: new Date() // Guarda la fecha de creación
                });
                showMessage("Huelga creada exitosamente.", 3000);
                createStrikeForm.reset(); // Limpia el formulario

                // Refrescar la lista de huelgas para el delegado después de crear una nueva
                // El listener de onSnapshot ya se encarga de esto automáticamente, pero podemos forzar una actualización si es necesario
                // En este caso, el onSnapshot ya está activo y debería refrescar la UI.
            } catch (error) {
                console.error("Error al crear huelga:", error);
                showMessage("Error al crear la huelga.", 3000);
            }
        });

        // --- Funciones de la Sección del Estudiante (y Delegado) ---

        /**
         * Renderiza la lista de huelgas disponibles para los estudiantes o delegados.
         * @param {Array} strikes Un array de objetos huelga.
         * @param {string} targetContainerId El ID del elemento HTML donde se renderizará la lista.
         * @param {string} noStrikesMessageId El ID del elemento de mensaje "no hay huelgas".
         */
        async function displayStrikesForStudents(strikes, targetContainerId, noStrikesMessageId) { // Made async
            const targetContainer = document.getElementById(targetContainerId);
            const noStrikesMsg = document.getElementById(noStrikesMessageId);

            if (!targetContainer) { // Safety check - now includes return
                console.error(`Target container with ID ${targetContainerId} not found. Exiting function.`);
                return; // Exit if container is null
            }
            if (!noStrikesMsg) { // Safety check - now includes return
                console.error(`No strikes message element with ID ${noStrikesMessageId} not found. Exiting function.`);
                return; // Exit if message element is null
            }

            targetContainer.innerHTML = '';
            console.log(`Calling displayStrikesForStudents for ${targetContainerId} with ${strikes.length} strikes. Current Student ID: ${currentStudentId}`); // NEW DEBUG

            if (strikes.length === 0) {
                noStrikesMsg.classList.remove('hidden');
                return;
            }
            noStrikesMsg.classList.add('hidden');

            let studentAdhesions = new Map(); // Map to store adhesion docs by strikeId

            // Fetch all adhesions for the current student once
            if (currentStudentId) {
                try {
                    const adhesionsQuery = query(collection(db, `artifacts/${appId}/public/data/strike_adhesions`), where('studentId', '==', currentStudentId));
                    const adhesionsSnapshot = await getDocs(adhesionsQuery);
                    adhesionsSnapshot.forEach(doc => {
                        studentAdhesions.set(doc.data().strikeId, doc); // Store the whole doc for later deletion
                    });
                    console.log(`Fetched ${studentAdhesions.size} adhesions for student ${currentStudentId} in ${targetContainerId}`); // NEW DEBUG
                } catch (error) {
                    console.error(`Error fetching adhesions for student ${currentStudentId} in ${targetContainerId}:`, error);
                    showMessage("Error al cargar tus adhesiones a huelgas.", 3000);
                }
            } else {
                console.warn(`currentStudentId is null for ${targetContainerId}. Cannot check student adhesions.`); // NEW DEBUG
            }

            const currentDate = new Date(); // Get current date/time for comparison
            currentDate.setHours(0, 0, 0, 0); // Normalize to start of day for comparison


            strikes.forEach(strike => {
                const strikeDate = new Date(strike.date); // Convert strike date string to Date object
                strikeDate.setHours(0, 0, 0, 0); // Normalize to start of day

                const isPastEvent = strikeDate < currentDate; // Check if the event date is in the past

                const strikeCard = document.createElement('div');
                // Añade la clase strike-card-relative para posicionamiento absoluto del badge
                strikeCard.className = 'bg-white p-4 rounded-lg shadow mb-4 last:mb-0 strike-card-relative'; 
                
                let badgeHtml = '';
                if (isPastEvent) {
                    badgeHtml = `<span class="event-finished-badge">Evento Finalizó</span>`;
                }

                strikeCard.innerHTML = `
                    ${badgeHtml}
                    <h4 class="text-lg font-semibold text-gray-800">${strike.description}</h4>
                    <p class="text-sm text-gray-600 mb-2">Fecha: ${strike.date} | Curso: ${strike.course}</p>
                    <div class="flex items-center">
                        <input type="checkbox" id="adhere-${strike.id}-${targetContainerId}" data-strike-id="${strike.id}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mr-2 adhere-checkbox">
                        <label for="adhere-${strike.id}-${targetContainerId}" class="text-gray-700 select-none cursor-pointer">Me adhiero a esta huelga</label>
                    </div>
                `;
                targetContainer.appendChild(strikeCard);

                const checkbox = strikeCard.querySelector(`#adhere-${strike.id}-${targetContainerId}`);
                const label = checkbox.parentElement.querySelector('label');

                if (checkbox) {
                    let existingAdhesionDoc = studentAdhesions.get(strike.id); // Check against the pre-fetched map

                    if (existingAdhesionDoc) {
                        checkbox.checked = true;
                        label.textContent = 'Ya te has adherido a esta huelga';
                        label.classList.add('text-green-600');
                    } else {
                        checkbox.checked = false;
                        label.textContent = 'Me adhiero a esta huelga';
                        label.classList.remove('text-green-600');
                    }

                    // Disable checkbox if currentStudentId is null OR if event is in the past
                    if (!currentStudentId || isPastEvent) {
                        checkbox.disabled = true;
                        if (!currentStudentId && !isPastEvent) { // Only change label if it's disabled due to no login, not past event
                            label.textContent = 'Inicia sesión para adherirte';
                            label.classList.add('text-gray-500');
                        } else if (isPastEvent) {
                            // If it's a past event, the badge handles the "finished" message
                            // Keep original adhesion status text if already adhered
                            // No change to label text here, badge handles finished state.
                            label.classList.remove('text-gray-500', 'text-green-600'); // Clean up old text colors
                        }
                    }

                    // Handle checkbox change event
                    checkbox.addEventListener('change', async (event) => {
                        if (!currentStudentId) { // Double check before operation
                            showMessage("Error: ID de estudiante no disponible. Intente iniciar sesión nuevamente.", 5000);
                            event.target.checked = !event.target.checked; // Revert checkbox state
                            return;
                        }
                        // Also prevent change if it's a past event
                        if (isPastEvent) {
                            showMessage("No puedes modificar la adhesión a un evento finalizado.", 3000);
                            event.target.checked = !event.target.checked; // Revert checkbox state
                            return;
                        }
                        
                        if (event.target.checked) {
                            // Logic to adhere
                            const publicIp = await getPublicIpAddress();
                            if (!publicIp) {
                                event.target.checked = false;
                                return;
                            }

                            try {
                                const newAdhesionRef = await addDoc(collection(db, `artifacts/${appId}/public/data/strike_adhesions`), {
                                    strikeId: strike.id,
                                    studentId: currentStudentId,
                                    studentUsername: currentStudentUsername,
                                    studentFullName: currentStudentFullName,
                                    publicIp: publicIp,
                                    adheredAt: new Date()
                                });
                                // Update the map for immediate UI consistency (though onSnapshot will eventually re-render)
                                studentAdhesions.set(strike.id, await getDoc(newAdhesionRef));
                                showMessage("¡Te has adherido a la huelga!", 3000);
                                label.textContent = 'Ya te has adherido a esta huelga';
                                label.classList.add('text-green-600');
                            } catch (error) {
                                console.error("Error al adherirse a la huelga:", error);
                                showMessage("Error al adherirse a la huelga. Por favor, inténtalo de nuevo.", 5000);
                                event.target.checked = false; // Revert checkbox state
                            }
                        } else {
                            // Lógica para desadherirse (desmarcar checkbox)
                            try {
                                const docToDelete = studentAdhesions.get(strike.id);
                                if (docToDelete) {
                                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/strike_adhesions`, docToDelete.id));
                                    studentAdhesions.delete(strike.id); // Remove from map
                                    showMessage("Has retirado tu adhesión a la huelga.", 3000);
                                    label.textContent = 'Me adhiero a esta huelga';
                                    label.classList.remove('text-green-600');
                                } else {
                                    showMessage("No se encontró adhesión para retirar.", 3000);
                                }
                            } catch (error) {
                                console.error("Error al retirar adhesión a la huelga:", error);
                                showMessage("Error al retirar la adhesión. Por favor, inténtalo de nuevo.", 5000);
                                event.target.checked = true; // Revert checkbox state
                            }
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
